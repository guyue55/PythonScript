# 使用教程（RAG检索增强生成）

提供从安装到运行的完整步骤，包含参数说明与排查建议。命令以当前项目结构为准，确保准确。

## 先决条件

- Python 3.9+（建议 3.10/3.11）
- Windows 环境下可能需要管理员权限安装部分包（如 `faiss-cpu`）

## 安装依赖

在项目根目录执行：

```
pip install -r RAG检索增强生成/requirements.txt
```

## 配置环境变量

- 复制 `RAG检索增强生成/.env.example` 为 `RAG检索增强生成/.env`
- 重要字段：
  - `RAW_DATA_DIR`：原始文档目录（默认 `RAG检索增强生成/data/raw`）
  - `INDEX_DATA_DIR`：索引保存目录（默认 `RAG检索增强生成/data/index`）
  - `CHUNK_SIZE` / `CHUNK_OVERLAP`：文本切分参数
  - `EMBEDDINGS_PROVIDER` / `EMBEDDINGS_MODEL`：嵌入模型设置
  - `VECTORSTORE`：向量库（默认降级实现；如需 FAISS/Chroma 请自行扩展或安装）
  - `LLM_PROVIDER` / `LLM_MODEL` / `OPENAI_API_KEY`：生成模型配置（可选）

## 准备数据

将 `.txt` 或 `.md` 文档放入：

```
RAG检索增强生成/data/raw/
```

建议内容干净、主题集中；可分多文件便于切分与检索。

## 构建索引（入库）

```
python RAG检索增强生成/scripts/ingest.py --source_dir RAG检索增强生成/data/raw --index_dir RAG检索增强生成/data/index
```

- 参数说明：
  - `--source_dir`：文档源目录（不填则读取 `.env` 的 `RAW_DATA_DIR`）
  - `--index_dir`：索引保存目录（不填则读取 `.env` 的 `INDEX_DATA_DIR`）

完成后，索引将保存到 `index_dir` 指定目录；日志会提示加载/切分/入库数量。

## 执行查询

- 检索 + 生成（如已配置 OpenAI）：

```
python RAG检索增强生成/scripts/query.py --query "什么是RAG？" --index_dir RAG检索增强生成/data/index
```

- 仅检索（不调用 LLM）：

```
python RAG检索增强生成/scripts/query.py --query "RAG的优势？" --index_dir RAG检索增强生成/data/index --no_llm
```

- 其他参数：
  - `--top_k`：控制返回的片段数量（默认 4），仅在 `--no_llm` 模式打印详情。

## 常见问题与排查

- 依赖安装失败（尤其 `faiss-cpu`）：
  - 使用默认降级检索（项目已内置），先确保流程可运行。
- 无法调用 OpenAI：
  - 使用 `--no_llm` 仅检索模式；或在 `.env` 填写 `OPENAI_API_KEY` 并选择合适的 `LLM_MODEL`。
- 检索结果不理想：
  - 调整 `CHUNK_SIZE` 与 `CHUNK_OVERLAP`；更换更强的 `EMBEDDINGS_MODEL`；检查文本是否包含大量噪声/重复。

## 进阶用法（建议）

- 返回来源引用：在生成答案中输出来源 `metadata['source']`，提升可信度。
- 批量入库：将大量文档按主题拆分目录，分批运行入库脚本，减少内存压力。
- 评测：编写简单评测脚本（如命题集）测试检索召回率与答案引用覆盖率。

---

如需 Web API 或更细粒度切分（按段落/标题），可在 `app/` 目录下扩展对应模块并复用现有管道。
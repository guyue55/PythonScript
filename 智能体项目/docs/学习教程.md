# 学习教程（智能体项目）

本教程帮助你系统掌握智能体项目的目标、结构、依赖、设计与核心流程，并进行代码导读与实践建议。内容严格对应当前代码，确保准确。

## 项目介绍

- 目标：构建一个可运行的 Python 智能体（Agent），具备：工具调用、对话记忆、LLM 生成与简单决策循环。
- 特点：安全的工具执行（安全计算器与公开搜索）、可持久化记忆、模块化架构，易扩展。

## 目录结构（当前实际）

```
智能体项目/
├── README.md
├── requirements.txt
├── .env.example
├── app/
│   ├── __init__.py
│   ├── config.py
│   ├── utils/
│   │   └── logging.py
│   ├── services/
│   │   └── llm.py
│   ├── tools/
│   │   ├── web_search.py
│   │   └── calculator.py
│   ├── memory/
│   │   └── memory.py
│   └── agent/
│       └── agent.py
├── storage/
│   └── （运行时生成 memory.json）
└── scripts/
    └── run.py
```

## 依赖与工具（用途准确）

- `python-dotenv`：加载 `.env` 配置（LLM/API/记忆等）。
- `openai`：官方 OpenAI SDK，用于 LLM 文本生成（可选）。
- `duckduckgo-search`：公共 Web 搜索工具，无需注册即可使用。
- `numpy`：基础数值计算（项目仅少量依赖，可扩展使用）。
- `pydantic`：数据模型与校验（可用于扩展，当前项目未强依赖）。
- `rich`：更友好的终端输出（可用于扩展）。

安装版本以 `requirements.txt` 为准；OpenAI 为可选依赖，未配置时将使用回退生成。

## 设计与架构

- 配置层（`app/config.py`）：统一参数管理（LLM、搜索、记忆与日志级别）。
- 工具层（`app/tools/`）：
  - `web_search.py`：基于 `duckduckgo-search` 的文本搜索，返回标题与链接摘要。
  - `calculator.py`：安全计算器，使用 `ast` 限定语法，仅支持基础算术。
- 服务层（`app/services/llm.py`）：
  - `LLMService`：统一的文本生成接口；未配置外部 LLM 时使用回退回复。
- 记忆层（`app/memory/memory.py`）：
  - `ConversationMemory`：消息列表管理，滑动窗口读取，JSON 持久化存储。
- 智能体层（`app/agent/agent.py`）：
  - `Agent`：最简决策循环：判断是否搜索、尝试解析并计算表达式，最后调用 LLM 生成答案。
- 脚本层（`scripts/run.py`）：命令行入口，解析参数并执行智能体。

## 流程详解

- 工具与记忆：
  1. 接收用户任务，写入记忆（role=user）。
  2. 根据任务触发搜索或计算：
     - 搜索关键词（如“搜索/查找/news/热点/trending/资料”）触发 `web_search`。
     - 提取算术表达式（正则匹配）触发 `safe_calculate`。
  3. 将工具结果写入记忆（role=assistant），并记录工具日志。
- 生成：
  1. 从记忆中取滑动窗口（最近 10 条或配置值）。
  2. 使用 `LLMService.generate` 结合系统指令与消息列表生成最终答案。
  3. 将答案写入记忆（role=assistant），返回结果与工具日志。

## 代码导读（按文件）

- `app/config.py`：`AppConfig` 和 `load_config`，确保数值参数合法并统一加载。
- `app/utils/logging.py`：统一日志格式与级别。
- `app/services/llm.py`：OpenAI 客户端封装；无 API Key 时的回退策略。
- `app/tools/web_search.py`：DuckDuckGo 搜索实现与返回结构。
- `app/tools/calculator.py`：AST 安全计算，支持基础算术与一元正负号。
- `app/memory/memory.py`：JSON 持久化与裁剪逻辑。
- `app/agent/agent.py`：决策策略、工具调用与生成流程。
- `scripts/run.py`：参数解析（`--task`、`--max_steps`）与输出格式。

## 学习建议与实践

- 扩展工具：新增“文件读写”、“时间与日期”、“简单HTTP请求”工具，感知更多能力。
- 调整策略：根据任务类型更精细地匹配工具触发条件；增加多步推理与中间计划输出。
- 引用规范：在答案中附带来源链接和简要步骤，提升可解释性。
- 记忆管理：按会话/主题保存不同的记忆文件，构建长期记忆层。

## 常见问题与排查

- 未配置 OpenAI：仍可运行，使用回退生成；建议在 `.env` 设置 `OPENAI_API_KEY`。
- 搜索结果为空：变更关键词或降低限制；检查网络连通性。
- 计算报错：仅支持基础算术表达式；不支持函数与变量。

---

如需引入更复杂的规划（Planning）与工具协调（Toolformer/Function calling），可在现有模块基础上逐步扩展并增加单元测试。